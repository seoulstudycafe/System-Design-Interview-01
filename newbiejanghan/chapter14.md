# Chapter 14 유튜브 설계
### 시스템 개략적 이해
##### 비디오 업로드
1. 비디오 원본 저장소 (BLOB storage) 업로드
    1. Binary Large OBject
2. 트랜스코딩 서버는 원본 저장소로부터 비디오 가져와서 트랜스코딩 시작
3. 트랜스코딩 완료 이후
    1. CDN에 업로드
    2. 트랜스코딩 완료 이벤트 큐에 이벤트 전송
4. 트랜스코딩 완료 이벤트 핸들러
    1. 이벤트 데이터를 큐에서 꺼낸 다음,
    2. 메타데이터 캐시, 데이터베이스 갱신
5. API 서버는 유저의 조회 요청에 대하여
    1. 메타데이터 조회 이후, 스트리밍 준비가 되었음을 알려준다.

##### 스트리밍
- 프로토콜 종류를 이해해야 한다. 프로토콜마다 지원하는 비디오 인코딩, 플레이어가 다르기 때문이다.
- Moving Picture Experts Group
- 애플의 HTTP Live Streaming
- Microsoft Smooth Streaming
- Adobe HTTP Dynamic Streaming

### 트랜스코딩
##### 비트레이트(bitrate)
- 비디오를 구성하는 비트가 얼마나 빠르게 처리되어야 하는지에 대한 수치.
- 이 값과 비디오 포맷이 같으면 서로 다른 단말기 간 호환이 가능하다.
- 비트레이트가 높을 수록 고화질 영상이며 고성능이 컴퓨터 자원이 필요하다.

##### 인코딩 포맷
- 컨테이너: 비디오 파일, 오디오, 메타데이터를 담는 바구니. .avi, .mov, .mp4 등의 확장자
- 코덱(codev): 비디오 화질을 보존하면서 용량을 줄이는 압축 및 압축 해제 알고리즘.

##### 유향 비순한 그래프 (Directed Acyclic Graph) 모델
- 동영상 제작자마다의 다양한 요구사항을 충족하면서 (유연성) 동시에 여러 작업을 병렬적으로 처리할 수 있는 (병렬성) 작업 모델
- 다양한 요구 사항?
    - 난 워터마크 넣을래
    - 난 썸네일도 커스텀할거야.
- 클라이언트가 설정한 트랜스코딩 작업 요소에 따라 graph 형태의 작업도를 작성한다음 해당 그래프를 병렬적으로 처리하는 방식.

##### 트랜스코딩 아키텍쳐
1. 전처리기
    1. 비디오를 GOP(Group of Picture) 단위로 쪼개기
    2. DAG생성하기
    3. 데이터 캐시: 비디오 인코딩이 실패할 시 재개하기 위한 임시 데이터 저장
2. DAG 스케줄러
    1. 전처리기가 생성한 DAG 를 몇 단계로 쪼개어 자원 관리자의 큐에 넣는다.
3. 자원 관리자
    1. 작업의 우선순위, 여유 있는 작업 서버 판단 의 과정을 통해 작업을 최적화
4. 작업 서버
    1. 워터마크, 인코딩, 썸네일 등 각자의 역할을 맡은 여러 작업 서버

### 시스템 최적화
##### 속도 최적화
1. 비디오 병렬 업로드: GOP 단위로 업로드, 하나의 큰 비디오를 한 번에 업로드 하면 중간에 멈출 시 다시 처음부터 업로드 해야 함. chunking의 장점
2. CDN: 여러 지역의 CDN에 업로드하여 각 지역의 소비자가 물리적으로 가까운 네트워크에서 스트리밍 받을 수 있도록 함.
3. 병렬 처리: 전체 아키텍처의 각 모듈 간 메세지 큐 통신으로 결합도를 낮춤으로써 병렬 처리
##### 안정성 최적화
1. Presigend URL: 클라이언트에게 미리 업로드 예정인 객체에 대한 접근 권한을 부여할 수 있다는 장점. // TO-DO 이게 왜 장점이지?
2. 비디오 저작권 보고 방식
    1. Digital Rights Management 시스템
    2. AES 암호화: 허락된 사용자만 볼 수 있게 암호화 하고 재생 시 복호화하는 방식
    3. 워터마크
##### 비용 최적화
CDN 최적화
1.  일반적으로 CDN에 업로드된 영상의 스트리밍 횟수 그래프는 long-tail
    즉, 인기 없는 영상은 CDN에 굳이 업로드될 필요가 없음.
2. 지역마다 인기 있는 영상이 다름.
3. CDN 직접 구축 후 지역 별 ISP와 제휴
    - 트위치와 한국의 사례?